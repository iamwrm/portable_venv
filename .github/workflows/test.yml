name: Test Portable Environment

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.2
      
      - name: Install dependencies
        run: pixi install
      
      - name: Test locally
        run: pixi run python test_venv.py
      
      - name: Install pixi-pack
        run: pixi global install pixi-pack

      - name: Create portable archive
        run: |
          export PATH="$HOME/.pixi/bin:$PATH"
          pixi-pack -o env.tar
          ls -lh env.tar

      - name: Download pixi-unpack
        run: ./download_pixi_unpack.sh

      - name: Test in bare Debian container
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -w /app \
            debian:13 \
            bash -c "./pixi-unpack env.tar -o /app && ./env/bin/python test_venv.py"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: portable-env
          path: |
            env.tar
            pixi-unpack

  cpp-example:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.62.2
          manifest-path: cpp_example/pixi.toml

      - name: Build and test locally (GCC + Clang)
        run: pixi run --manifest-path cpp_example/pixi.toml test

      - name: Install pixi-pack
        run: pixi global install pixi-pack

      - name: Create portable archive
        run: |
          export PATH="$HOME/.pixi/bin:$PATH"
          pixi-pack -o cpp_example/env.tar cpp_example
          ls -lh cpp_example/env.tar

      - name: Download pixi-unpack
        run: ./download_pixi_unpack.sh

      - name: Test in bare Debian container (GCC + Clang)
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE/cpp_example:/app \
            -v $GITHUB_WORKSPACE/pixi-unpack:/usr/local/bin/pixi-unpack \
            -w /app \
            debian:13 \
            bash -c '
              pixi-unpack env.tar -o /app

              echo "=== Testing GCC ==="
              env/bin/c++ -o zstd_gcc main.cpp -I env/include -L env/lib -lzstd
              LD_LIBRARY_PATH=env/lib ./zstd_gcc

              echo "=== Testing Clang ==="
              env/bin/clang++ -o zstd_clang main.cpp -I env/include -L env/lib -lzstd
              LD_LIBRARY_PATH=env/lib ./zstd_clang
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: portable-cpp-env
          path: cpp_example/env.tar

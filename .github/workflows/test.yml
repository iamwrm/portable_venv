name: Test Portable Environment

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Pixi
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.40.3
      
      - name: Install dependencies
        run: pixi install
      
      - name: Test locally
        run: pixi run python test_venv.py
      
      - name: Download pixi-pack (standalone binary)
        run: |
          curl -fsSL https://github.com/Quantco/pixi-pack/releases/latest/download/pixi-pack-x86_64-unknown-linux-musl -o pixi-pack
          chmod +x pixi-pack
          ./pixi-pack --version

      - name: Create self-extracting executable
        run: |
          ./pixi-pack --create-executable -o environment
          ls -lh environment
          file environment

      - name: Test in bare Debian container
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -w /app \
            debian:13 \
            bash -c "./environment && ./env/bin/python test_venv.py"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: portable-env-executable
          path: environment
